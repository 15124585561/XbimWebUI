

/* Copyright (c) 2014, xBIM Team, Northumbria University. All rights reserved.

This javascript library is part of xBIM project. It is provided under the same 
Common Development and Distribution License (CDDL) as the xBIM Toolkit. For 
more information see http://www.openbim.org

Redistribution and use in source and binary forms, with or without modification,
are permitted provided that the following conditions are met:

  * Redistributions of source code must retain the above copyright notice, this
    list of conditions and the following disclaimer.
  * Redistributions in binary form must reproduce the above copyright notice,
    this list of conditions and the following disclaimer in the documentation
    and/or other materials provided with the distribution.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR
ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
(INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE. */

﻿function xAttributeDictionary(lang,culture){var dictionaries=[{lang:'en',culture:'uk',terms:{AssetDescription:"Asset Description",AssetInstallationDate:"Asset Installation Date",AssetName:"Asset Name",AssetSerialNumber:"Asset Serial Number",AssetTypeCategory:"Asset Type Category",AssetTypeColorCode:"Asset Type Color Code",AssetTypeDescription:"Asset Type Description",AssetTypeFeaturesDescription:"Asset Type Features Description",AssetTypeGradeDescription:"Asset Type Grade Description",AssetTypeMaterialDescription:"Asset Type Material Description",AssetTypeName:"Asset Type Name",AssetTypeShapeDescription:"Asset Type Shape Description",AssetTypeSizeDescription:"Asset Type Size Description",AssetWarrantyStartDate:"Asset Warranty Start Date",AttributeCategory:"Attribute Category",AttributeDescription:"Attribute Description",AttributeName:"Attribute Name",FacilityCategory:"Facility Category",FacilityDefaultAreaUnit:"Facility Default Area Unit",FacilityDefaultLinearUnit:"Facility Default Linear Unit",FacilityDefaultVolumeUnit:"Facility Default Volume Unit",FacilityDeliverablePhaseName:"Facility Deliverable Phase Name",FacilityDescription:"Facility Description",FacilityName:"Facility Name",FloorCategory:"Floor Category",FloorDescription:"Floor Description",FloorName:"Floor Name",ProjectDescription:"Project Description",ProjectName:"Project Name",SiteDescription:"Site Description",SpaceCategory:"Space Category",SpaceDescription:"Space Description",SpaceName:"Space Name",SpaceSignageName:"Space Signage Name",StringValue:"String Value",SystemCategory:"System Category",SystemDescription:"System Description",SystemName:"System Name",UnitName:"Unit Name",ZoneCategory:"Zone Category",ZoneDescription:"Zone Description",ZoneName:"Zone Name",externalID:"External ID",externalIDReference:"External ID Reference",propertySetName:"Property Set",True:"True",False:"False"}}];for(var i in dictionaries){var terms=dictionaries[i].terms;terms.get=function(term){return terms[term]?terms[term]:term;};}
var def=dictionaries.filter(function(e){return e.lang=='en'&&e.culture=='uk';})[0].terms;if(typeof(lang)=='undefined'&&typeof(culture)=='undefined')
return def;var candidates=dictionaries.filter(function(e){return e.lang==lang});if(candidates.length==0)
return def;if(candidates.length==1||typeof(culture)=='undefined')
return candidates[0].terms;candidates2=candidates.filter(function(e){return e.culture==culture});if(candidates2.length==1)
return candidates2[0].terms;else
return candidates[0].terms;}﻿
function xBrowser(){this._data=null;this._model=new xVisualModel();this._events=[];this._utils=new xCobieUtils();this._templates={};var templateStrings=xVisualTemplates();for(var t in templateStrings){var templateString=templateStrings[t];this._templates[t]=this._compileTemplate(templateString);}}
xBrowser.prototype._compileTemplate=function(str){return new Function("_data_","var _p_=[];"+"with(_data_){_p_.push('"+
str.replace(/[\r\t\n]/g," ").split("<%").join("\t").replace(/((^|%>)[^\t]*)'/g,"$1\r").replace(/\t=(.*?)%>/g,"',$1,'").split("\t").join("');").split("%>").join("_p_.push('").split("\r").join("\\'")
+"');}return _p_.join('');");};xBrowser.prototype.renderSpatialStructure=function(container,initTree){if(!this._model)throw'No data to be rendered. Use this function in an event handler of "loaded" event.';this._renderTreeView(container,[this._model.facility],initTree);};xBrowser.prototype.renderAssetTypes=function(container,initTree){if(!this._model)throw'No data to be rendered. Use this function in an event handler of "loaded" event.';this._renderTreeView(container,this._model.assetTypes,initTree);};xBrowser.prototype.renderSystems=function(container){if(!this._model)throw'No data to be rendered. Use this function in an event handler of "loaded" event.';this._renderListView(container,this._model.systems,null,'wrench');};xBrowser.prototype.renderZones=function(container){if(!this._model)throw'No data to be rendered. Use this function in an event handler of "loaded" event.';this._renderListView(container,this._model.zones,null,'newwin');};xBrowser.prototype._registerEntityCallBacks=function(element,entity){var self=this;element.entity=entity;element.addEventListener('click',function(e){self._fire('entityClick',{entity:entity,event:e});e.stopPropagation();});element.addEventListener('mouseDown',function(e){self._fire('entityMouseDown',{entity:entity,event:e});e.stopPropagation();});element.addEventListener('mouseUp',function(e){self._fire('entityMouseUp',{entity:entity,event:e});e.stopPropagation();});element.addEventListener('mouseMove',function(e){self._fire('entityMouseMove',{entity:entity,event:e});e.stopPropagation();});element.addEventListener('touch',function(e){self._fire('entityTouch',{entity:entity,event:e});e.stopPropagation();});element.addEventListener('dblclick',function(e){self._fire('entityDblclick',{entity:entity,event:e});e.stopPropagation();});};xBrowser.prototype._uiTree=function(container){if(!container)return;if(!jQuery||!jQuery.ui)return;var elements=typeof(container)=='string'?$("#"+container+" li"):$(container).find('li');elements.on("click",function(e){e.stopPropagation();$(this).children('ul').slideToggle();var closed=$(this).children('span[class~="ui-icon-triangle-1-e"]');var opened=$(this).children('span[class~="ui-icon-triangle-1-s"]');if(closed.length>0)closed.removeClass('ui-icon-triangle-1-e').addClass('ui-icon-triangle-1-s');if(opened.length>0)opened.removeClass('ui-icon-triangle-1-s').addClass('ui-icon-triangle-1-e');}).prepend(function(){if($(this).children('ul').length>0)
return'<span class="ui-icon ui-icon-triangle-1-s" style="float: left;"></span>';else
return'<span class="ui-icon ui-icon-document" style="float: left;"></span>';}).css('list-style-type','none').css('cursor','default').click();};xBrowser.prototype._renderListView=function(container,entities,entityTemplate,uiIcon){var self=this;container=this._getContainer(container);entityTemplate=entityTemplate?entityTemplate:self._templates.entity;var table=document.createElement('table');container.appendChild(table);for(var i=0;i<entities.length;i++){var entity=entities[i];var html=entityTemplate(entity);var tr=document.createElement('tr');table.appendChild(tr);var td=document.createElement('td');tr.appendChild(td);td.innerHTML=html;this._registerEntityCallBacks(td,entity);if(uiIcon&&jQuery&&jQuery.ui){$(td).prepend('<span class="ui-icon ui-icon-'+uiIcon+'" style="float: left;"></span>');}}};xBrowser.prototype._renderTreeView=function(container,roots,initSimpleTree,entityTemplate){var self=this;container=this._getContainer(container);entityTemplate=entityTemplate?entityTemplate:self._templates.entity;initSimpleTree=initSimpleTree?initSimpleTree:false;var renderEntities=function(entities,ul){for(var i=0;i<entities.length;i++){var entity=entities[i];var html=entityTemplate(entity);var li=document.createElement('li');li.innerHTML=html;self._registerEntityCallBacks(li,entity);if(!ul){var ul=document.createElement('ul');container.appendChild(ul);}
ul.appendChild(li);if(entity.children&&entity.children.length>0){var inUl=document.createElement('ul');li.appendChild(inUl);renderEntities(entity.children,inUl)}}};renderEntities(roots);if(initSimpleTree)this._uiTree(container);};xBrowser.prototype.renderDocuments=function(entity,container){if(!entity)throw'No data to be rendered. Use this function in an event handler of "loaded" event.';var self=this;container=this._getContainer(container);var docs=entity.documents;if(docs){this._renderListView(container,docs,null,'document');}};xBrowser.prototype.renderIssues=function(entity,container){if(!entity)throw'No data to be rendered. Use this function in an event handler of "loaded" event.';var self=this;container=this._getContainer(container);var issues=entity.issues;if(issues){this._renderListView(container,issues,null,'clipboard');}};xBrowser.prototype.renderAttributes=function(entity,container){if(!entity)throw'No data to be rendered. Use this function in an event handler of "loaded" event.';var self=this;container=this._getContainer(container);var html=self._templates.attribute(entity);container.innerHTML=html;};xBrowser.prototype.renderProperties=function(entity,container){if(!entity)throw'No data to be rendered. Use this function in an event handler of "loaded" event.';var self=this;container=this._getContainer(container);var html=self._templates.property(entity);container.innerHTML=html;};xBrowser.prototype.renderPropertiesAttributes=function(entity,container){if(!entity)throw'No data to be rendered. Use this function in an event handler of "loaded" event.';var self=this;container=this._getContainer(container);var html=self._templates.propertyattribute(entity);container.innerHTML=html;};xBrowser.prototype._getContainer=function(container){if(typeof(container)=='object')return container;if(typeof(container)=='string'){container=document.getElementById(container);if(container)return container;}
if(!container)return document.documentElement;};xBrowser.prototype.load=function(source){if(typeof(source)=='undefined')throw'You have to define a source to JSON data.';var self=this;var xhr=new XMLHttpRequest();xhr.open('GET',source,true);xhr.onreadystatechange=function(){if(xhr.readyState==4&&xhr.status==200){self._data=xhr.response;self._model=self._utils.getVisualModel(self._data);self._fire('loaded',{model:self._model});}
if(xhr.readyState==4&&xhr.status!=200){var msg='Failed to fetch semantic JSON data from server. Server code: '+xhr.status+'. This might be due to CORS policy of your browser if you run this as a local file.';throw msg;}};xhr.responseType='json';xhr.send();};xBrowser.prototype._getPresentationModel=function(){if(!this._data)throw'No data to be converted to presentation model';var result={};};xBrowser.prototype.on=function(eventName,callback){var events=this._events;if(!events[eventName]){events[eventName]=[];}
events[eventName].push(callback);};xBrowser.prototype.onRemove=function(eventName,callback){var events=this._events;var callbacks=events[eventName];if(!callbacks){return;}
var index=callbacks.indexOf(callback)
if(index>=0){callbacks.splice(index,1);}};xBrowser.prototype._fire=function(eventName,args){var handlers=this._events[eventName];if(!handlers){return;}
for(var i in handlers){handlers[i](args);}};﻿function xCobieUtils(){this._dictionary=new xAttributeDictionary();};xCobieUtils.prototype.settings={decimalPlaces:4};xCobieUtils.prototype.getVisualEntity=function(entity,type){if(!entity||!type)throw'entity must be defined';var id=entity.externalID;var name="";var description="";for(var a in entity){if(a.toLowerCase()==(type+'name').toLowerCase())
name=entity[a];if(a.toLowerCase()==(type+'description').toLowerCase())
description=entity[a];if(name.length!=0&&description.length!=0)
break;}
return new xVisualEntity({id:id,type:type,name:name,description:description,attributes:this.getAttributes(entity),properties:this.getProperties(entity),assignments:this.getAssignments(entity,type),documents:this.getDocuments(entity,type),issues:this.getIssues(entity)});};xCobieUtils.prototype.getVisualModel=function(data){if(!data)throw'data must be defined';var types=this.getAssetTypes(data);return new xVisualModel({facility:this.getSpatialStructure(data,types),zones:this.getZones(data),systems:this.getSystems(data),assetTypes:types,contacts:[]});};xCobieUtils.prototype.getSpatialStructure=function(data,types){if(!data)throw'data must be defined';var facility=this.getVisualEntity(data,'facility');var floors=data.Floors;if(!floors)
return facility;floors=floors.Floor;if(!floors||floors.length==0)
return facility;for(var i in floors){var floor=floors[i];var vFloor=this.getVisualEntity(floor,'floor');facility.children.push(vFloor);var spaces=floor.Spaces;if(!spaces)continue;spaces=spaces.Space;if(!spaces)continue;for(var s in spaces){var space=spaces[s];var vSpace=this.getVisualEntity(space,'space');vFloor.children.push(vSpace);}}
types=types?types:this.getAssetTypes(data);for(var t in types){var type=types[t];for(var i in type.children){var instance=type.children[i];var spaceAssignment=instance.assignments.filter(function(e){return e.type=='space'})[0];if(!spaceAssignment)continue;var spaceProp=spaceAssignment.properties.filter(function(e){return e.id=='SpaceName'})[0];var floorProp=spaceAssignment.properties.filter(function(e){return e.id=='FloorName'})[0];if(!floorProp||!spaceProp)continue;var spaceName=spaceProp.value;var floorName=floorProp.value;var floor=facility.children.filter(function(e){return e.name==floorName;})[0];if(!floor)continue;var space=floor.children.filter(function(e){return e.name==spaceName})[0];if(!space)continue;space.children.push(instance);}}
return facility;};xCobieUtils.prototype.getZones=function(data){if(!data)throw'data must be defined';var result=[];var zones=data.Zones;if(!zones)return result;zones=zones.Zone;if(!zones)return result;for(var z in zones){var zone=zones[z];var vZone=this.getVisualEntity(zone,'zone');result.push(vZone);}
return result;};xCobieUtils.prototype.getSystems=function(data){if(!data)throw'data must be defined';var result=[];var systems=data.Systems;if(!systems)return result;systems=systems.System;if(!systems)return result;for(var s in systems){var system=systems[s];var vSystem=this.getVisualEntity(system,'system');result.push(vSystem);}
return result;};xCobieUtils.prototype.getAssetTypes=function(data){if(!data)throw'data must be defined';var result=[];var types=data.AssetTypes;if(!types)return result;types=types.AssetType;if(!types)return result;for(var t in types){var type=types[t];var vType=this.getVisualEntity(type,'assettype');result.push(vType);var instances=type.Assets;if(!instances)continue;instances=instances.Asset;if(!instances)continue;for(var i in instances){var instance=instances[i];var vInstance=this.getVisualEntity(instance,'asset');vType.children.push(vInstance);}}
return result;};xCobieUtils.prototype.getProperties=function(entity){if(!entity)throw'entity must be defined';var tr=this.getTranslator();var result=[];for(var a in entity){var attr=entity[a];var valStr=this.getValueString(attr);if(!valStr)continue;var nameStr=tr(a);result.push(new xVisualProperty({name:nameStr,value:valStr,id:a}));}
return result;};xCobieUtils.prototype.getAttributes=function(entity){if(!entity)throw'entity must be defined';var di=this.getTranslator();var result=[];var attributes=null;for(var a in entity){if(a.indexOf('Attributes')!=-1&&entity[a].Attribute){attributes=entity[a].Attribute;break;}}
if(!attributes)return result;for(var a in attributes){var attribute=attributes[a];result.push(new xVisualAttribute({name:attribute.AttributeName,description:attribute.AttributeDescription,value:this.getValueString(attribute.AttributeValue),propertySet:attribute.propertySetName,category:attribute.AttributeCategory,issues:attribute.AttributeIssues?this.getAttributes(attribute.AttributeIssues):[]}));}
return result;};xCobieUtils.prototype.getAssignments=function(entity,type){if(!entity||!type)throw'entity and type must be defined';var result=[];for(var attr in entity){var r=new RegExp('^('+type+').*(assignments)$','i');if(r.test(attr)){for(var a in entity[attr]){var assignmentSet=entity[attr][a]
var name=a.replace('Assignment','').toLowerCase();for(var a in assignmentSet){var assignment=assignmentSet[a];var vAssignment=this.getVisualEntity(assignment,name);result.push(vAssignment);}}}}
return result;};xCobieUtils.prototype.getDocuments=function(entity,type){if(!entity||!type)throw'entity and type must be defined';var result=[];for(var attr in entity){var r=new RegExp('^('+type+')(documents)$','i');if(r.test(attr)){var documents=entity[attr].Document
if(!documents)continue;for(var i=0;i<documents.length;i++){var doc=documents[i]
var vDoc=this.getVisualEntity(doc,'document')
result.push(vDoc);}}}
return result;};xCobieUtils.prototype.getIssues=function(entity){if(!entity||!type)throw'entity and type must be defined';var result=[];for(var attr in entity){if(entity[attr].Issue){var issues=entity[attr].Issue
for(var i=0;i<issues.length;i++){var issue=issues[i]
var vIssue=this.getVisualEntity(doc,'issue')
result.push(vIssue);}}}
return result;};xCobieUtils.prototype.setLanguage=function(lang,culture){this._dictionary=new xAttributeDictionary(lang,culture);};xCobieUtils.prototype.getValueString=function(value){var tr=this._dictionary.get;if(!value)throw'Object must be defined';if(value.Item)value=value.Item;var baseVal="";if(typeof(value)=='string')baseVal=value;if(value.BooleanValue)baseVal=value.BooleanValue?tr('True'):tr('False');if(value.StringValue)baseVal=value.StringValue;if(typeof(value.DecimalValue)!='undefined')baseVal=value.DecimalValue.toFixed(this.settings.decimalPlaces).toString();if(typeof(value.IntegerValue)!='undefined')baseVal=value.IntegerValue.toString();if(value.UnitName)baseVal+=' '+value.UnitName;return baseVal.length>0?baseVal:null;};xCobieUtils.prototype.getTranslator=function(){return this._dictionary.get;};﻿function xVisualAttribute(values){this.name="";this.description="";this.value="";this.propertySet="";this.category="";this.issues=[];if(typeof(values)=='object'){for(var a in values){this[a]=values[a];}}};﻿function xVisualEntity(values){this.id="";this.type="";this.name="";this.description="";this.attributes=[];this.properties=[];this.documents=[];this.issues=[];this.assignments=[];this.children=[];this.warranties=[];if(typeof(values)=='object'){for(var a in values){this[a]=values[a];}}};﻿function xVisualModel(values){this.facility=[];this.zones=[];this.systems=[];this.contacts=[];this.assetTypes=[];if(typeof(values)=='object'){for(var a in values){this[a]=values[a];}}};﻿function xVisualProperty(values){this.name="";this.value="";this.id="";if(typeof(values)=='object'){for(var a in values){this[a]=values[a];}}};﻿function xVisualTemplates(){return{property:'<%if (properties && properties.length > 0) {%><table> \
    <% for (var p in properties) { var prop = properties[p];%> \
    <tr> \
        <td><%=prop.name%></td>\
        <td><%=prop.value%></td>\
    </tr>\
    <%}%>\
</table> \
<%}%>',attribute:'<% if (attributes && attributes.length > 0) {\
    var psets = [];\
    for(var i = 0; i < attributes.length; i++){\
        var attr = attributes[i]; var pset = attr.propertySet; if (pset) {if(psets.indexOf(pset) == -1){psets.push(pset);}}\
    }\
%>\
<table> \
    <% for (var p in psets) { var psetName = psets[p]; var pset = attributes.filter(function(e){ return e.propertySet == psetName;});\
%>\
<tr><th colspan="2"><%=psetName%></th></tr>\
<%for (var a in pset) { var attr = pset[a];%> \
    <tr title="<%=attr.description%>"> \
        <td><%=attr.name%></td>\
        <td><%=attr.value%></td>\
    </tr>\
    <%}}%>\
</table>\
<%}%>',propertyattribute:'<%if (properties.length > 0 || attributes.length > 0) {%><table> \
    <% for (var p in properties) { var prop = properties[p];%> \
    <tr> \
        <td><%=prop.name%></td>\
        <td><%=prop.value%></td>\
    </tr>\
    <%}%>\
<%}\
if (attributes && attributes.length > 0) {\
    var psets = [];\
    for(var i = 0; i < attributes.length; i++){\
        var attr = attributes[i]; var pset = attr.propertySet; if (pset) {if(psets.indexOf(pset) == -1){psets.push(pset);}}\
    }\
%>\
    <% for (var p in psets) { var psetName = psets[p]; var pset = attributes.filter(function(e){ return e.propertySet == psetName;});\
%>\
<tr><th colspan="2"><%=psetName%></th></tr>\
<%for (var a in pset) { var attr = pset[a];%> \
    <tr title="<%=attr.description%>"> \
        <td><%=attr.name%></td>\
        <td><%=attr.value%></td>\
    </tr>\
    <%}}%>\
</table>\
<%}%>',entity:'<span title="<%=description%>"> <%=name%> </span>',}};