<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
    <link href="Libs/jquery-ui-styles/jquery-ui.min.css" rel="stylesheet" />
    <link href="Resources/doctemplate/static/styles/xbrowser-styles.css" rel="stylesheet" />

    <script src="Libs/jquery.js"></script>
    <script src="Libs/jquery-ui.js"></script>
    <script src="Build/xbim-browser.js"></script>
    <script src="Build/xbim-viewer.debug.bundle.js"></script>
</head>
<body>
    <canvas id="viewer"></canvas>
    <div id="semantic-model-container" class="noselect">
        <div id="semantic-model">
            <h3>Spatial structure</h3>
            <div class="no-overflow">
                <div id="structure" class="semantic-model-tree"></div>
            </div>
            <h3>Asset types</h3>
            <div class="no-overflow">
                <div id="assetTypes" class="semantic-model-tree"></div>
            </div>
            <h3>Systems</h3>
            <div class="no-overflow">
                <div id="systems" class="semantic-model-tree"></div>
            </div>
            <h3>Zones</h3>
            <div class="no-overflow">
                <div id="zones" class="semantic-model-tree"></div>
            </div>
            <h3>Documents</h3>
            <div class="no-overflow">
                <div id="facility-documents" class="semantic-model-tree"></div>
            </div>
        </div>
    </div>

    <div id="semantic-descriptive-info-container" class="no-overflow-y ui-widget ui-widget-content ui-corner-all">
        <div id="semantic-descriptive-info" class="">
            <div>
                <h3>Properties and attributes</h3>
                <div id="attrprop"></div>
            </div>
        </div>
    </div>
    <script type="text/javascript">
        function visualSelection(container) {
            $("#" + container + " span[title]").on('click', function (e) {
                $("#" + container + " span[title]").removeClass('ui-selected');
                $(this).addClass('ui-selected')
            }).css({ cursor: 'default', padding: '3px' });
        }

        var browser = new xBrowser();
        browser.on('loaded', function (args) {
            var facility = args.model.facility;
            //render parts
            browser.renderSpatialStructure('structure', true);
            browser.renderAssetTypes('assetTypes', true);
            browser.renderSystems('systems');
            browser.renderZones('zones');
            browser.renderDocuments(facility, 'facility-documents');

            //open facility node
            $("#structure > ul > li").click();

            visualSelection('structure');
            visualSelection('assetTypes');
            visualSelection('systems');
            visualSelection('zones');
            visualSelection('facility-documents');

        });

        browser.on('entityDblclick', function (args) {
            var entity = args.entity;
            var allowedTypes = ['space', 'assettype', 'asset'];
            if (allowedTypes.indexOf(entity.type) == -1) return;

            var id = parseInt(entity.id);
            if (id && viewer) {
                viewer.resetStates();
                if (entity.type == 'assettype') {
                    var ids = [];
                    for (var i = 0; i < entity.children.length; i++) {
                        id = parseInt(entity.children[i].id);
                        ids.push(id);
                    }
                    viewer.setState(xState.HIGHLIGHTED, ids);
                }
                else {
                    viewer.setState(xState.HIGHLIGHTED, [id]);
                }
                viewer.zoomTo(id);
            }
        });

        $('#semantic-model').accordion({
            heightStyle: 'fill'
        });

        $(window).resize(function () {
            $('#semantic-model').accordion('destroy').accordion({
                heightStyle: 'fill'
            });

        });

        browser.on('entityClick', function (args) {
            browser.renderPropertiesAttributes(args.entity, 'attrprop');
        });
        browser.load('tests/data/COBieFacility.json');

        //viewer set up
        var check = xViewer.check();
        var viewer = null;
        if (check.noErrors) {
            var width = $(window).width();
            var height = $(window).height();
            var canvas = document.getElementById('viewer');
            canvas.width = width;
            canvas.height = height;

            viewer = new xViewer(canvas);
            viewer.on('mouseDown', function (args) {
                viewer.setCameraTarget(args.id);
            });
            viewer.load('tests/data/LakesideRestaurant.wexbim');
            viewer.start();
        }
        else {
            var msg = document.getElementById('msg');
            msg.innerHTML = '';
            for (var i in check.errors) {
                var error = check.errors[i];
                msg.innerHTML += "<div style='color: red;'>" + error + "</div>";
            }
        }
    </script>
</body>
</html>
